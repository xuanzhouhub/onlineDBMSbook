# 关系代数

关系代数是一种抽象的查询语言，它用对关系的运算来表达用户的访问需求。关系代数表达式既易于计算机识别和处理又能充分地表达用户的查询逻辑，是关系数据库查询语言的理论基础。本小节将详细介绍关系代数的相关内容。

## 关系运算

<center>
	<img src="fig/chapter4.3-4.4-RelationOperator.jpg" width="30%" alt="Relation Operator" />
	<br>
	<div display: inline-block; padding : 2px>
		图 4.4 关系代数运算符
	</div>
</center>

任何一种运算都是将运算符作用于一定的运算对象上，然后得到运算结果。运算对象、运算符和运算结果是运算的三大要素。关系代数的运算对象是关系，运算结果也是关系。关系代数的运算符包括四类：集合运算符、专门的关系运算符、比较运算符和逻辑运算符，如图4.4所示。按运算符进行划分，关系代数的运算可以分为：

* 集合运算：将关系看成元组的集合，从行的角度进行运算。集合运算是二目运算，包括并（union）、交（intersection）、差（except）和笛卡尔积（cartesian product）四种运算，分别记作 $ R \cup S$, $ R \cap S$，$ R - S$， $R \times S$，其中$R$和$S$表示关系。
* 关系运算：从关系的行和列进行运算，包括选择（selection）、投影（projection）、连接（join）和除（division）四类运算，分别记作$\sigma_F(R)$，$\Pi_A(R)$，$R \Join_{A \theta B} S$，$R \div S$，其中$R$和$S$表示关系，$F$表示比较运算表达式，$A$和$B$表示属性，$\theta$表示比较运算符。
* 比较运算：是为了辅助关系运算而进行的操作。比较运算用比较运算符比较两个值，其结果是一个逻辑值“真”或“假”。在关系运算中，通常记作 $X \theta Y$， 其中$\theta$表示比较运算符$>$，$\ge$，$<$，$\le$，$=$，$<> $等，$X$和$Y$可以是属性名，常量或者简单的函数。
* 逻辑运算：也是为辅助关系运算而进行的操作。在关系运算中，逻辑运算用逻辑运算符对若干个比较运算结果进行运算，其结果也是一个逻辑值，常用的逻辑运算符有与($\land$)、或($\lor$)和非($\neg$)。

关系代数中最常用的是关系运算。接下来将介绍选择、投影、连接和除四类关系运算。

（1）选择

选择（$\sigma$）是一个一元算子，它是从关系$R$中选择出满足给定条件的所有元组，记作$$\sigma_F(R)=\{t | t\in R \land F(t) = '真' \}$$其中，$t$表示元组；$F$是比较运算表达式，又称为选择条件，它的运算对象是关系$R$中的各个属性。选择运算表达式实际上表示的是从关系$R$中选取出使比较运算表达式$F$为真的元组。换而言之， 选择运算是用选择条件$F$对关系$R$中的元组进行过滤，过滤之后的结果是由一个或者多个元组组成的新关系，所以选择运算是从关系的行角度进行的运算。

下面的例子展示了用选择运算来描述用户的查询需求，并给出了选择运算的结果。选择运算的对象是图4.3的学生关系。


> [例4.1]  查询姓名为浩宇的学生。 关系运算表示为：$\sigma_{sname='浩宇'}(Student)$，运算结果如图4.5(a)所示 。<br>
> [例4.2] 查询年龄小于19岁的女学生。关系运算表示为：$\sigma_{gender='女' \land age < 19}(Student)$，运算结果如图4.5(b)所示。<br>

<center>
	<img src="fig/chapter4.3-4.5-selection.jpg" width="40%" alt="Selection" />
	<br>
	<div display: inline-block; padding : 2px>
		图 4.5 选择运算举例
	</div>
</center>

（2）投影

投影（$\Pi$）是一个一元算子，它是从关系$R$中选择出若干属性列组成的新关系，记作$$\Pi_A(R)=\{t[A] | t \in  R\}$$其中，$A$是关系$R$的一个属性或者多个属性组成的属性组，又称为投影条件；$t[A]$则表示元组$t$在属性组$A$上各属性值的集合。投影运算其实是对关系$R$做垂直切分，只留下属性组$A$，投影结果是由属性组$A$的属性值组成的新关系。所以，投影运算是从关系的列角度进行的运算。值得特别注意的是，投影之后的结果不能包含重复的元组，因此投影运算还需要去掉新关系中完全相同的元组。

下面展示了在图4.3中学生关系上的投影运算。

> [例4.3]  查询学生的学号和姓名。 关系运算表示为：$\Pi_{sno,sname}(Student)$，运算结果如图4.6(a)所示 。<br>
> [例4.4] 查询学生的系。关系运算表示为：$\Pi_{dept}(Student)$，运算结果如图4.6(b)所示。<br>

<center>
	<img src="fig/chapter4.3-4.6-projection.jpg" width="30%" alt="Projection" />
	<br>
	<div display: inline-block; padding : 2px>
		图 4.6 投影运算举例
	</div>
</center>

（3）连接

连接（$\Join$）是一个二元算子，它是从两个关系$R$和$S$的笛卡尔积中选取满足给定条件的元组，记作$$R \Join_{A\theta B} S = \{^\frown_{t_r,t_s} | t_r \in R \land t_s \in S \land t_r[A] \theta t_s[B] = '真'\}$$其中，$A\theta B$是比较运算表达式，又称连接条件。$A$是关系$R$的属性组，$B$是关系$S$的属性组，$A$和$B$称为连接属性组，它们的列数相等且属性值具有可比性；$^\frown_{t_r,t_s}$表示关系$R$和$S$的笛卡尔积。这里笛卡尔积称为广义笛卡尔积，因为它的元素是关系的元组，记作$R \times S$，它是用关系$R$中的元组为第一元素，关系$S$中的元组为第二元素构成有序对，然后由所有的有序对组成的集合。也就是说，如果关系$R$有$n$个属性和$k_1$个元组，关系$S$有$m$个属性和$k_2$个元组，那么它们的笛卡尔积有$n+m$个属性和$k_1 \times k_2$个元组。连接运算的执行过程是先对关系$R$和$S$求笛卡尔积，然后用连接条件对笛卡尔积中的元组进行过滤，过滤之后的结果是由$A$属性组上的值与$B$属性组上的值满足比较运算符$\theta$的元组构成。


连接运算包括内连接（inner join）、自然连接（nature join）和外连接（outer join）三种，其中最常用且最重要的连接是内连接中的等值连接和自然连接。

* 内连接：就是通常所说的连接运算，也称为连接。根据连接条件中比较运算符$\theta$的不同，可以分为等值连接和不等连接。等值连接是比较运算符$\theta$为“$=$”的连接运算，也就是从关系$R$和$S$的笛卡尔积中选取$A$、$B$属性值相等的元组。不等值连接就是比较运算符为除等号之外的连接运算。
* 自然连接：是一种特殊的等值连接。它要求$R$和$S$两个关系中进行比较的属性组必须同名，并且在连接结果中要去掉重复的属性列。
*  外连接：与内连接和自然连接不同，外连接的结果中保留了关系$R$和$S$中不满足连接条件的元组。这些不满足连接条件的元组称为悬浮元组。外连接分为左外连接（left outer join或left join）、右外连接（right outer join 或者right join）和全外连接（full outer join 或者outer join）。左外连接是保留左边关系$R$中的悬浮元组，记作$R ⟕ S$。由于右边关系$S$没有与$R$悬浮元组相连接的元组，因此连接结果中$S$的属性上填空值(NULL)。右外连接是保留右边关系$S$中的悬浮元组，记作$ R ⟖ S$。同样地，右外连接结果中悬浮元组中的左边关系$R$的属性上填空值。全外连接简称为外连接，是同时保留关系$R$和$S$的悬浮元组，对应悬浮元组的其他属性上填空值，记作 $R ⟗S$。

下例中展示了在图4.3中学生关系和选课关系上的等值连接和自然连接。

> [例4.5] 查询学生和该学生的选课信息。 等值连接表示为：$Student \Join_{Student.sno=SC.sno} SC$，运算结果如图4.7(a)所示 。<br>
> [例4.6] 查询学生和该学生的选课信息。自然连接表示为：$Student \Join SC$，运算结果如图4.7(b)所示。

<center>
	<img src="fig/chapter4.3-4.7-equaljoin.jpg" width="66%" alt="Equal Join" />
	<br>
	<div display: inline-block; padding : 2px>
		图 4.7 等值连接和自然连接举例
	</div>
</center>

下例中展示了在图4.8中关系$R$和$S$的外连接、左外连接和右外连接运算。

> [例4.7] 关系$R$和关系$S$的外连接，表示为：$SR ⟗S$，运算结果如图4.8(b)所示 。<br>
> [例4.8] 关系$R$和关系$S$的左外连接，表示为：$R ⟕ S$，运算结果如图4.8(c)所示。<br>
>  [例4.9] 关系$R$和关系$S$的右外连接，表示为：$R ⟖ S $，运算结果如图4.8(d)所示。

<center>
	<img src="fig/chapter4.3-4.8-outerjoin.jpg" width="60%" alt="Outer Join" />
	<br>
	<div display: inline-block; padding : 2px>
		图 4.8 外连接运算举例
	</div>
</center>

（4） 除

除($\div$)是一个二元算子。它的定义是：如果关系$R(X,Y)$除以关系$S(Y,Z)$得到的结果为关系$T(X)$，其中$X,Y,Z$都是属性组，$R$中的$Y$和$S$中的$Y$可以是不同的属性名，但属性值必须来自相同的域。关系$T$是关系$R$在属性$X$上的投影，投影后的元组满足以下条件：属性值$x$在关系$R$中的象集$Y_x$包含关系$S$在$Y$上投影的集合。记作$$R \div S = \{t_r[X] | t_r \in  R \land \Pi_Y(S) \subseteq Y_x\}$$其中$x=t_r[X]$，$t_r[X]$表示元组$t$是在关系$R$的属性组$X$上的投影集合，$\Pi_Y(S) $是在关系$S$上对属性组$Y$的投影集合，$Y_x$是属性值$x$在$R$中的象集。$x$在$R$中的象集指的是关系$R$中每个属性值$x$的所有元组在$Y$上属性值的集合。更通俗一点地说，就是先根据$x$属性值对关系$R$进行分组，每个组内$Y$的属性值集合就是该组$x$的象集，记作$$Y_x = \{t[Y] | t \in R, t[X] = x\}$$

除运算是同时从行和列的角度进行运算。除运算的执行按以下步骤：

* 首先，按属性组$X$的值对关系$R$进行分组，然后求得每个属性值$x$在$R$中的象集，即关系$S$中每个$x$的所有$Y$的属性值的集合；
* 然后，进行关系$S$在属性组$Y$上的投影运算，得到关系$S$中$Y$的属性值的集合；
* 最后，选取象集中包含了$S$在$Y$属性组上投影结果的所有$x$。

下例展示了图4.9中关系$R$和$S$的除运算。

> [例4.10] 关系$R$和关系$S$的除运算，表示为：$R \div S$，运算结果如图4.9(c)所示 。<br>

例4.10的执行过程如下：在关系$R$中，属性$A$的取值为$\{a1,a2,a3,a4\}$。首先，分别计算它们的象集，其中$a1$的象集为$\{(b1,c2),(b2,c3),(b2,c1)\}$；$a2$的象集为$\{(b3,c7),(b2,c3)\}$；$a3$的象集为$\{(b4,c6)\}$；$a4$的象集为$\{(b6,c6)\}$。然后，计算关系$S$在$(B,C)$上的投影为$\{(b1,c2),(b2,c3),(b2,c1)\}$。最后，比较各象集和关系$S$的投影结果，只有$a1$的象集包含了$S$在$(B,C)$上的投影，所以，$R \div S = \{a1\}$。


<center>
	<img src="fig/chapter4.3-4.9-division.jpg" width="40%" alt="Divison" />
	<br>
	<div display: inline-block; padding : 2px>
		图 4.9 除运算举例
	</div>
</center>


## 关系代数表达式

在关系代数中，由关系代数运算经有限次复合而成的式子称为关系代数表达式，它可以用于描述用户的数据查询和更新需求。

下面通过举例来说明，如何用关系代数表达式描述用户需求。查询需求是基于图4.3中的学生选课数据库的关系模型，其中包括学生关系、课程关系和选课关系。通常关系也称为表。

> [例4.11] 查询选修课程名为"高数"的学生学号<br>

直接将查询需求转换成关系代数表达式并不是那么容易的。我们可以先用逻辑表达式来描述查询需求，然后再将逻辑表达式转换为关系表达式。例$4.11$查询需求的逻辑表达式为：

> 令：$f(x): x 是一名学生; g(y): y是高数课程;  r(xy): x选修了课程y $ <br>
> 则 $\exists x \in f(x) \wedge \exists y \in g(y) \wedge r(xy)$ 表示选修高数课程的学生

查询的结果需要使得逻辑表达式中的三个断言都为真，其中，$\exists y \in g(y) $是课程关系中课程名为"高数"的元组， $r(xy)$则是课程关系与选课关系连接之后，再与学生关系连接的结果。由于课程关系与选课关系的连接结果中已包含学生的学号信息，因此例$4.11$不需要执行与学生关系的连接运算。整个过程如下：先通过选择运算从课程关系中选取课程名为"高数"的元组，然后将选择结果与选课关系进行等值连接，最后在连接的结果中做在学号属性上的投影运算。关系代数表达式则记作：$$\Pi_{SC.sno}(\sigma_{cname=‘数学’}(Course) \Join_{Course.sno=SC.sno} SC)$$如果查询需求改为查询选修课程名为“高数”的学生姓名，那么关系代数表达式则为：$$\Pi_{Student.sname}(\sigma_{cname=‘数学’}(Course) \Join_{Course.cno=SC.cno} SC \Join_{SC.sno=Student.sno} Student)$$

虽然关系代数表达式能够描述一些复杂的查询需求，但是基于关系代数的数据查询语言对于程序员而言并不友好，增加了应用程序的编程难度。为此，在关系代数表达式的基础之上，数据库系统的实践者提出了一种对程序员更加友好的用户访问语言SQL。在数据访问过程中，用户首先用SQL语言来表达数据操作需求并将SQL语句交给数据库系统，然后，数据库系统将SQL语句翻译成关系代数表达式，最后根据关系代数表达式进行处理并得到最终的查询结果。


























